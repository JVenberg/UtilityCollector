rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to get normalized (lowercase) email
    function normalizedEmail() {
      return request.auth.token.email.lower();
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(normalizedEmail())) &&
        get(/databases/$(database)/documents/users/$(normalizedEmail())).data.role == 'admin';
    }

    // Helper function to check if user is a registered user (admin or member)
    function isRegisteredUser() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(normalizedEmail()));
    }

    // Check if this is the bootstrap admin email
    function isBootstrapAdmin() {
      return request.auth != null && normalizedEmail() == 'jvenberg@gmail.com';
    }

    // Users collection - for role management
    match /users/{userEmail} {
      // Any authenticated user can read (to check their own role)
      allow read: if request.auth != null;
      // Admins can write, OR bootstrap admin can create their own document
      allow create: if isAdmin() || (isBootstrapAdmin() && userEmail == 'jvenberg@gmail.com');
      allow update, delete: if isAdmin();
    }

    // Units collection - main data
    match /units/{unitId} {
      // Allow read for registered users
      allow read: if isRegisteredUser();
      // Allow write only for admin users
      allow write: if isAdmin();
    }

    // Bills collection - utility bills
    match /bills/{billId} {
      // Allow read for registered users
      allow read: if isRegisteredUser();
      // Allow write only for admin users
      allow write: if isAdmin();

      // Subcollections for readings and adjustments - admin only
      match /readings/{readingId} {
        allow read: if isRegisteredUser();
        allow write: if isAdmin();
      }

      match /adjustments/{adjustmentId} {
        allow read: if isRegisteredUser();
        allow write: if isAdmin();
      }

      match /invoices/{invoiceId} {
        allow read: if isRegisteredUser();
        // Allow write if admin OR if user's email matches the unit's current email
        allow create, delete: if isAdmin();
        allow update: if isAdmin() || (
          isRegisteredUser() &&
          get(/databases/$(database)/documents/units/$(resource.data.unit_id)).data.email == request.auth.token.email
        );
      }

      // Solid waste assignments subcollection - admin only
      match /solid_waste_assignments/{assignmentId} {
        allow read: if isRegisteredUser();
        allow write: if isAdmin();
      }
    }

    // Gmail tokens - for OAuth storage (only admin should access)
    match /gmail_tokens/{tokenId} {
      allow read, write: if isAdmin();
    }

    // Settings/config - read for registered users, write for admin only
    match /settings/{settingId} {
      // Registered users can read settings (needed for payment_instructions, meter_reading_status)
      allow read: if isRegisteredUser();
      // Only admins can write settings
      allow write: if isAdmin();
    }
  }
}
